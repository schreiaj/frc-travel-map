<!DOCTYPE html>
<html>
<meta charset="utf-8">
<style>

/* CSS goes here. */

</style>

<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0-alpha.2/dc.css" media="screen" title="no title" charset="utf-8">
<body>

<svg width=100% height=100% viewBox="0 0 1000 600"></svg>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/d3.geo.projection.v0.min.js"></script>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/crossfilter/1.3.11/crossfilter.min.js"></script>
<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/dc/2.0.0-alpha.2/dc.js"></script>

<script>


// var distanceChart = dc.lineChart("#distanceChart")
/* JavaScript goes here. */
var width = 1000,
    height = 600;

var svg = d3.select("body").select("svg")
    // .attr("width", width)
    // .attr("height", height);

d3.select("body").append("div").attr("id", "distanceChart")

var list = d3.select("body").append("ul").classed("list", true)

var renderedEvents = []

var cFilter = crossfilter()

var filters = {}

filters['distance'] = cFilter.dimension(function(d){return 10*Math.floor(d.distance/10,1)})
filters['team'] = cFilter.dimension(function(d){return d.team})
filters['event'] = cFilter.dimension(function(d){return d.eventData.key})
filters['eventType'] = cFilter.dimension(function(d){return eventTypeScale(d.eventData.event_type)})


distanceChart = dc.lineChart("#distanceChart").dimension(filters['distance'])
  .x(d3.scale.linear().domain([0,0]))
  .group(filters['distance'].group())
  .width(1000)
  .height(300)
  .elasticX(true)
  .elasticY(true)

dc.renderAll()




// var colorScale = d3.scale.category10().domain([0,10000]);
//
var mercator = d3.geo.mercator()
  .rotate([90, 0])
  .scale((width + 1) / 2 / Math.PI)
  .translate([width / 2, height / 2])
  .precision(.1)

d3.json("countries.geo.json", function(error, world) {
  svg.insert("path", ".graticule")
    .datum(topojson.feature(world, world.objects.land))
    .attr("class", "land")
    .attr("d", d3.geo.path().projection(mercator));
});


d3.json("events-2014.json", function(error, events) {
  events.forEach(function(e){
    e.start_date = Date(e.start_date)
    e.end_date = Date(e.end_date)
    if(e.official)
      loadEvent(e)
  })
})

var path = d3.geo.path()
  .projection(mercator)


var eventTypeScale = d3.scale.ordinal()
  .domain([0, 1, 2, 3, 4, 99, 100, -1])
  .range(['regional', 'district', 'district_championship', 'championship_division', 'championship_finals', 'offseason', 'preseason', '' ])

var graticule = d3.geo.graticule();

svg.append("path")
    .datum(graticule)
    .attr("class", "graticule")
    .attr("d", d3.geo.path().projection(mercator));


function loadEvent(eventData){

  d3.json(eventData.key+".json", function(error, event){
    links = []
    event.forEach(function(e){

      links.push({
        team: e.team,
        distance: e.distance,
        eventData: eventData,
        type: "LineString",
        coordinates: [
          e.team_location.coordinates,
          e.event_location.coordinates
        ]
      })
    })

    cFilter.add(links)

    renderedEvents.push(eventData)
    updateRenderedEvents();
  })

}


function renderTravel(data){

  svg.selectAll(".arc").remove()
  pathArcs = svg.selectAll(".arc")

    .data(data)

  pathArcs.enter()
    .append("path")
    .attr("d", path)
    .attr("class", function(d){return "team_"+d.team + " frc"+d.eventData.key})
    .classed("arc", true)
    // .classed("frc"+eventData.key, true)

    // .classed((eventData.event_district_string||"").replace(" ","_").toLowerCase(), true)
    // .classed(eventTypeScale(eventData.event_type), true)
    // .attr("style", function(d){return "stroke:"+colorScale(d.distance)+";"})
    // .on("mouseover", function(d){return select("#"+d.team)})
    // .on("mouseout", function(d){return deselect(d)})
}



function select(code){
  svg.selectAll(code).classed("active", true)
}

function hide(){
  svg.selectAll(".arc").classed("hidden", true)

}

function deselect(code){
  svg.selectAll(".active").classed("active", false)
  svg.selectAll(".arc").classed("hidden", false)
}


function updateRenderedEvents(){
  list.selectAll("li")
    .data(renderedEvents)
    .enter()
    .append("li")
    .text(function(d){return d.short_name})
    .on("mouseover", function(d){return select(".frc"+d.key)})
    .on("mouseout", function(d){return deselect(d.key)})
    renderTravel(filters['distance'].top(Infinity))
    distanceChart
      .x(d3.scale.linear().domain([filters['distance'].bottom(1)[0].distance||0, filters['distance'].top(1)[0].distance||0]))
    dc.redrawAll()

}


</script>
<style media="screen">
  path{
    fill:none;
    stroke: gray;
    stroke-width: 1.2;
  }

  .arc{
    stroke-opacity: 0.3;
    stroke: gray;
    stroke-width: 0.5;
  }



  .hidden{
    stroke-opacity: 0.1;
    stroke: gray;
    stroke-width: 0.05;
  }
  .active{
    stroke-opacity: 0.6;
    stroke: red;
    stroke-width: 0.75;
  }

  .list{
    /*font-size: 12px;*/
    position: absolute;
    /*left: 1000px;*/
    right: 10px;
    top: 0px;
    height: 90%;
    overflow: scroll;
    width: 200px;
    cursor: pointer;
    background-color: rgba(20,20,20,.6);
    margin-top:10px;
    border-radius: 5px;
    color: white;
  }

  .list li{
    padding-top:5px;
  }

  .boundary {
    fill: none;
    stroke: #fff;
    stroke-width: .5px;
  }

  .graticule {
    fill: none;
    stroke: #777;
    stroke-width: .5px;
    stroke-opacity: .25;
  }

  svg{
    min-height:400px;
  }
}
</style>
</body>
</html>
